<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Minecraft Ping Dashboard</title>
<link href="https://fonts.cdnfonts.com/css/minecraft-4" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
*{box-sizing:border-box;font-family:'Minecraft',sans-serif}
body{
  margin:0;min-height:100vh;
  background: linear-gradient(rgba(0,0,0,.75),rgba(0,0,0,.75)),
  url("beaa776788318ffa9adf475282e18bb5.gif") center/cover no-repeat fixed;
  display:flex;flex-direction:column;align-items:center;color:#0ff;
}
.card{
  width:95%;max-width:500px;padding:20px;
  background:rgba(0,0,0,.45);backdrop-filter:blur(16px);
  border-radius:20px;box-shadow:0 0 30px #0ff;margin-top:20px
}
h1{text-align:center;margin:0 0 10px}
input,select,button{
  width:100%;padding:12px;margin:8px 0;border-radius:10px;border:none
}
input,select{background:#111;color:#0ff}
button{background:#0ff;color:#000;font-weight:bold}
button:active{transform:scale(.97)}
.result{text-align:center;margin-top:6px}
.good{color:#0f0}.medium{color:#ff0}.bad{color:#f33}
canvas{margin-top:10px;width:100%;height:100px;border-radius:10px;box-shadow:0 0 15px #0ff}
#map{height:200px;width:100%;margin-top:10px;border-radius:12px;box-shadow:0 0 15px #0ff}
.small{text-align:center;font-size:12px;opacity:.8}
</style>
</head>
<body>

<div class="card">
  <h1>MC PING DASHBOARD</h1>
  <input id="ip" placeholder="Server IP (play.hypixel.net)">
  <input id="port" value="25565">
  <select id="type">
    <option value="java">Java</option>
    <option value="bedrock">Bedrock</option>
    <option value="geyser">Geyser</option>
    <option value="other">Other</option>
  </select>
  <button onclick="checkPing()">Check Ping</button>

  <div class="result" id="status">Ready</div>
  <div class="result" id="ping"></div>
  <div class="result" id="quality"></div>
  <div class="result" id="minmax"></div>
  <div class="result" id="timeinfo"></div>
  <div class="result" id="location"></div>

  <canvas id="graph"></canvas>
  <div id="map"></div>
  <div class="small">Tip: First click may wake server</div>
</div>

<audio id="alertSound" src="sounds/alert.mp3"></audio>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const API="https://ping-yies.onrender.com/ping";
const canvas=document.getElementById("graph"),ctx=canvas.getContext("2d");
let hist=[],times=[],minPing=null,maxPing=null,waking=false,marker=null;

// Leaflet map setup
const map=L.map('map').setView([20,0],2);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(map);

let autoPingInterval=null;

function checkPing(){
  const ip=document.getElementById("ip").value.trim();
  const port=document.getElementById("port").value.trim()||"25565";
  const type=document.getElementById("type").value;
  if(!ip){set("Enter server IP ❌");return}

  fetchPing(ip,port,type);
  if(autoPingInterval) clearInterval(autoPingInterval);
  autoPingInterval = setInterval(()=>fetchPing(ip,port,type),5000); // auto every 5s
}

function fetchPing(ip,port,type){
  set("Checking...");
  document.getElementById("ping").innerText="";
  document.getElementById("quality").innerText="";

  fetch(`${API}?ip=${ip}&port=${port}&type=${type}`)
    .then(r=>r.json())
    .then(d=>{
      if(!d.online){set("Server Offline ❌");return}
      waking=false;

      const p=d.ping;

      // Min / Max ping
      minPing=minPing===null?p:Math.min(minPing,p);
      maxPing=maxPing===null?p:Math.max(maxPing,p);
      document.getElementById("minmax").innerText=`Min: ${minPing} ms | Max: ${maxPing} ms`;

      // Last check time
      const now=new Date().toLocaleTimeString();
      times.push(now); if(times.length>20) times.shift();
      document.getElementById("timeinfo").innerText=`Last check: ${now}`;

      // Current ping
      hist.push(p); if(hist.length>20) hist.shift();
      document.getElementById("ping").innerText=`Ping: ${p} ms`;

      // Quality
      let t="GOOD",cls="good";
      if(p>200){t="BAD";cls="bad";playSound()}
      else if(p>120){t="MEDIUM";cls="medium"}
      document.getElementById("quality").innerHTML=`<span class="${cls}">${t}</span>`;

      // Location + Map
      fetchLocation(ip);

      set("Server Online ✅");
      drawGraph();
    })
    .catch(()=>{
      if(!waking){waking=true;set("Waking server… tap again ⏳");}
    });
}

function fetchLocation(ip){
  fetch(`https://ipapi.co/${ip}/json/`)
    .then(r=>r.json())
    .then(data=>{
      if(data && data.latitude && data.longitude){
        document.getElementById("location").innerText=`Server location: ${data.city || 'Unknown'}, ${data.country_name || 'Unknown'}`;
        if(marker) marker.remove();
        marker=L.marker([data.latitude,data.longitude]).addTo(map)
          .bindPopup(`Server: ${ip}<br>${data.city || 'Unknown'}, ${data.country_name || 'Unknown'}`)
          .openPopup();
        map.setView([data.latitude,data.longitude],4);
      }else{
        document.getElementById("location").innerText="Server location: Unknown";
      }
    })
    .catch(()=>document.getElementById("location").innerText="Server location: Unknown");
}

function playSound(){const a=document.getElementById("alertSound");a.currentTime=0;a.play()}
function set(s){document.getElementById("status").innerText=s}

function drawGraph(){
  canvas.width=canvas.clientWidth;
  canvas.height=100;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(hist.length<1) return;

  ctx.beginPath();
  ctx.strokeStyle="#0ff";
  ctx.lineWidth=2;

  const scale = 400; // ping max scale
  hist.forEach((p,i)=>{
    const x = i*(canvas.width/(hist.length-1||1));
    const y = canvas.height - Math.min(p,scale)/scale*canvas.height;
    i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
  });
  ctx.stroke();
}
</script>
</body>
</html>
